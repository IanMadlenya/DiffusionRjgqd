

 BiJGQD.density=function(Xs,Ys,Xt=seq(1,18,1/2),Yt=seq(1,18,1/2),s,t,delt,Dtype='Edgeworth')
 {

   # Warning Module
   if(delt>0.1){warning("Large delt may result in poor approximations.");}
   if(delt>=1) {stop("delt must be <1.");}
   nnn=length(Xt)
   if(length(Yt)!=nnn){warning("Yt and Xt must be of same length.");return(NULL);}

   X1=matrix(outer(Xt,rep(1,nnn)),1,nnn*nnn,byrow=T)
   X2=matrix(t(outer(Yt,rep(1,nnn))),1,nnn*nnn,byrow=T)


    Mstar1 =
   c("+1*mm1"
   ,"+2*mm1*m10+1*mm2"
   ,"+3*mm1*m20+3*mm2*m10+1*mm3"
   ,"+4*mm1*m30+6*mm2*m20+4*mm3*m10+1*mm4"
   ,"+1*oo1"
   ,"+2*oo1*m01+1*oo2"
   ,"+3*oo1*m02+3*oo2*m01+1*oo3"
   ,"+4*oo1*m03+6*oo2*m02+4*oo3*m01+1*oo4"
   ,"mm1*m01+oo1*m10+mm1*oo1"
   ,"mm1*m02+2*oo1*m11+2*mm1*oo1*m01+oo2*m10+mm1*oo2"
   ,"2*mm1*m11+mm2*m01+oo1*m20+2*mm1*oo1*m10+mm2*oo1"
   ,"2*mm1*m12+mm2*m02+2*oo1*m21+4*mm1*oo1*m11+2*mm2*oo1*m01+oo2*m20+2*mm1*oo2*m10+mm2*oo2"
   ,"mm1*m03+3*oo1*m12+3*mm1*oo1*m02+3*oo2*m11+3*mm1*oo2*m01+oo3*m10+mm1*oo3"
   ,"3*mm1*m21+3*mm2*m11+mm3*m01+oo1*m30+3*mm1*oo1*m20+3*mm2*oo1*m10+mm3*oo1")

    Mstar2 =
   c("+1*nn1"
   ,"+2*nn1*m10+1*nn2"
   ,"+3*nn1*m20+3*nn2*m10+1*nn3"
   ,"+4*nn1*m30+6*nn2*m20+4*nn3*m10+1*nn4"
   ,"+1*pp1"
   ,"+2*pp1*m01+1*pp2"
   ,"+3*pp1*m02+3*pp2*m01+1*pp3"
   ,"+4*pp1*m03+6*pp2*m02+4*pp3*m01+1*pp4"
   ,"nn1*m01+pp1*m10+nn1*pp1"
   ,"nn1*m02+2*pp1*m11+2*nn1*pp1*m01+pp2*m10+nn1*pp2"
   ,"2*nn1*m11+nn2*m01+pp1*m20+2*nn1*pp1*m10+nn2*pp1"
   ,"2*nn1*m12+nn2*m02+2*pp1*m21+4*nn1*pp1*m11+2*nn2*pp1*m01+pp2*m20+2*nn1*pp2*m10+nn2*pp2"
   ,"nn1*m03+3*pp1*m12+3*nn1*pp1*m02+3*pp2*m11+3*nn1*pp2*m01+pp3*m10+nn1*pp3"
   ,"3*nn1*m21+3*nn2*m11+nn3*m01+pp1*m30+3*nn1*pp1*m20+3*nn2*pp1*m10+nn3*pp1")

      Mstar1x =
   c("+1*mm1*m10"
   ,"+2*mm1*m20+1*mm2*m10"
   ,"+3*mm1*m30+3*mm2*m20+1*mm3*m10"
   ,"+4*mm1*m40+6*mm2*m30+4*mm3*m20+1*mm4*m10"
   ,"+1*oo1*m10"
   ,"+2*oo1*m11+1*oo2*m10"
   ,"+3*oo1*m12+3*oo2*m11+1*oo3*m10"
   ,"+4*oo1*m13+6*oo2*m12+4*oo3*m11+1*oo4*m10"
   ,"mm1*m11+oo1*m20+mm1*oo1*m10"
   ,"mm1*m12+2*oo1*m21+2*mm1*oo1*m11+oo2*m20+mm1*oo2*m10"
   ,"2*mm1*m21+mm2*m11+oo1*m30+2*mm1*oo1*m20+mm2*oo1*m10"
   ,"2*mm1*m22+mm2*m12+2*oo1*m31+4*mm1*oo1*m21+2*mm2*oo1*m11+oo2*m30+2*mm1*oo2*m20+mm2*oo2*m10"
   ,"mm1*m13+3*oo1*m22+3*mm1*oo1*m12+3*oo2*m21+3*mm1*oo2*m11+oo3*m20+mm1*oo3*m10"
   ,"3*mm1*m31+3*mm2*m21+mm3*m11+oo1*m40+3*mm1*oo1*m30+3*mm2*oo1*m20+mm3*oo1*m10")

    Mstar1y =
   c("+1*mm1*m01"
   ,"+2*mm1*m11+1*mm2*m01"
   ,"+3*mm1*m21+3*mm2*m11+1*mm3*m01"
   ,"+4*mm1*m31+6*mm2*m21+4*mm3*m11+1*mm4*m01"
   ,"+1*oo1*m01"
   ,"+2*oo1*m02+1*oo2*m01"
   ,"+3*oo1*m03+3*oo2*m02+1*oo3*m01"
   ,"+4*oo1*m04+6*oo2*m03+4*oo3*m02+1*oo4*m01"
   ,"mm1*m02+oo1*m11+mm1*oo1*m01"
   ,"mm1*m03+2*oo1*m11+2*mm1*oo1*m02+oo2*m11+mm1*oo2*m01"
   ,"2*mm1*m12+mm2*m02+oo1*m21+2*mm1*oo1*m11+mm2*oo1*m01"
   ,"2*mm1*m13+mm2*m03+2*oo1*m22+4*mm1*oo1*m12+2*mm2*oo1*m02+oo2*m21+2*mm1*oo2*m11+mm2*oo2*m01"
   ,"mm1*m04+3*oo1*m13+3*mm1*oo1*m03+3*oo2*m11+3*mm1*oo2*m02+oo3*m11+mm1*oo3*m01"
   ,"3*mm1*m22+3*mm2*m12+mm3*m02+oo1*m31+3*mm1*oo1*m21+3*mm2*oo1*m11+mm3*oo1*m02")

    Mstar2x =
   c("+1*nn1*m10"
   ,"+2*nn1*m20+1*nn2*m10"
   ,"+3*nn1*m30+3*nn2*m20+1*nn3*m10"
   ,"+4*nn1*m40+6*nn2*m30+4*nn3*m20+1*nn4*m10"
   ,"+1*pp1*m10"
   ,"+2*pp1*m11+1*pp2*m10"
   ,"+3*pp1*m12+3*pp2*m11+1*pp3*m10"
   ,"+4*pp1*m13+6*pp2*m12+4*pp3*m11+1*pp4*m10"
   ,"nn1*m11+pp1*m20+nn1*pp1*m10"
   ,"nn1*m12+2*pp1*m21+2*nn1*pp1*m11+pp2*m20+nn1*pp2*m10"
   ,"2*nn1*m21+nn2*m11+pp1*m30+2*nn1*pp1*m20+nn2*pp1*m10"
   ,"2*nn1*m22+nn2*m12+2*pp1*m31+4*nn1*pp1*m21+2*nn2*pp1*m11+pp2*m30+2*nn1*pp2*m20+nn2*pp2*m10"
   ,"nn1*m13+3*pp1*m22+3*nn1*pp1*m12+3*pp2*m21+3*nn1*pp2*m11+pp3*m20+nn1*pp3*m10"
   ,"3*nn1*m31+3*nn2*m21+nn3*m11+pp1*m40+3*nn1*pp1*m30+3*nn2*pp1*m20+nn3*pp1*m10")


    Mstar2y =
   c("+1*nn1*m01"
   ,"+2*nn1*m11+1*nn2*m01"
   ,"+3*nn1*m21+3*nn2*m11+1*nn3*m01"
   ,"+4*nn1*m31+6*nn2*m21+4*nn3*m11+1*nn4*m01"
   ,"+1*pp1*m01"
   ,"+2*pp1*m02+1*pp2*m01"
   ,"+3*pp1*m03+3*pp2*m02+1*pp3*m01"
   ,"+4*pp1*m04+6*pp2*m03+4*pp3*m02+1*pp4*m01"
   ,"nn1*m02+pp1*m11+nn1*pp1*m01"
   ,"nn1*m03+2*pp1*m12+2*nn1*pp1*m02+pp2*m11+nn1*pp2*m01"
   ,"2*nn1*m12+nn2*m02+pp1*m21+2*nn1*pp1*m11+nn2*pp1*m01"
   ,"2*nn1*m13+nn2*m03+2*pp1*m22+4*nn1*pp1*m12+2*nn2*pp1*m02+pp2*m21+2*nn1*pp2*m11+nn2*pp2*m01"
   ,"nn1*m04+3*pp1*m13+3*nn1*pp1*m03+3*pp2*m12+3*nn1*pp2*m02+pp3*m11+nn1*pp3*m01"
   ,"3*nn1*m22+3*nn2*m12+nn3*m02+pp1*m31+3*nn1*pp1*m21+3*nn2*pp1*m11+nn3*pp1*m01")

MAT = rbind(
 c("1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","","","","","","","","","","","","","","","","","","")
,c("2*m10","2*m20","2*m30","2*m11","2*m12","2*m21","","","","","","","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","","","","","","")
,c("3*m20","3*m30","3*m40","3*m21","3*m22","3*m31","","","","","","","3*m10","3*m20","3*m30","3*m11","3*m12","3*m21","","","","","","")
,c("4*m30","4*m40","4*m50","4*m31","4*m32","4*m41","","","","","","","6*m20","6*m30","6*m40","6*m21","6*m22","6*m31","","","","","","")
,c("","","","","","","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","","","","","","","","","","","","")
,c("","","","","","","2*m01","2*m11","2*m21","2*m02","2*m03","2*m12","","","","","","","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11")
,c("","","","","","","3*m02","3*m12","3*m22","3*m03","3*m04","3*m13","","","","","","","3*m01","3*m11","3*m21","3*m02","3*m03","3*m12")
,c("","","","","","","4*m03","4*m13","4*m23","4*m04","4*m05","4*m14","","","","","","","6*m02","6*m12","6*m22","6*m03","6*m04","6*m13")
,c("1*m01","1*m11","1*m21","1*m02","1*m03","1*m12","1*m10","1*m20","1*m30","1*m11","1*m12","1*m21","","","","","","","","","","","","")
,c("1*m02","1*m12","1*m22","1*m03","1*m04","1*m13","2*m11","2*m21","2*m31","2*m12","2*m13","2*m22","","","","","","","1*m10","1*m20","1*m30","1*m11","1*m12","1*m21")
,c("2*m11","2*m21","2*m31","2*m12","2*m13","2*m22","1*m20","1*m30","1*m40","1*m21","1*m22","1*m31","1*m01","1*m11","1*m21","1*m02","1*m03","1*m12","","","","","","")
,c("2*m12","2*m22","2*m32","2*m13","2*m14","2*m23","2*m21","2*m31","2*m41","2*m22","2*m23","2*m32","1*m02","1*m12","1*m22","1*m03","1*m04","1*m13","1*m20","1*m30","1*m40","1*m21","1*m22","1*m31")
,c("1*m03","1*m13","1*m23","1*m04","1*m05","1*m14","3*m12","3*m22","3*m32","3*m13","3*m14","3*m23","","","","","","","3*m11","3*m21","3*m31","3*m12","3*m13","3*m22")
,c("3*m21","3*m31","3*m41","3*m22","3*m23","3*m32","1*m30","1*m40","1*m50","1*m31","1*m32","1*m41","3*m11","3*m21","3*m31","3*m12","3*m13","3*m22","","","","","",""))

MAT2 = rbind(
 c("1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","","","","","","","","","","","","","","","","","","")
,c("2*mm10","2*mm20","2*mm30","2*mm11","2*mm12","2*mm21","","","","","","","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","","","","","","")
,c("3*mm20","3*mm30","3*mm40","3*mm21","3*mm22","3*mm31","","","","","","","3*mm10","3*mm20","3*mm30","3*mm11","3*mm12","3*mm21","","","","","","")
,c("4*mm30","4*mm40","4*mm50","4*mm31","4*mm32","4*mm41","","","","","","","6*mm20","6*mm30","6*mm40","6*mm21","6*mm22","6*mm31","","","","","","")
,c("","","","","","","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","","","","","","","","","","","","")
,c("","","","","","","2*mm01","2*mm11","2*mm21","2*mm02","2*mm03","2*mm12","","","","","","","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11")
,c("","","","","","","3*mm02","3*mm12","3*mm22","3*mm03","3*mm04","3*mm13","","","","","","","3*mm01","3*mm11","3*mm21","3*mm02","3*mm03","3*mm12")
,c("","","","","","","4*mm03","4*mm13","4*mm23","4*mm04","4*mm05","4*mm14","","","","","","","6*mm02","6*mm12","6*mm22","6*mm03","6*mm04","6*mm13")
,c("1*mm01","1*mm11","1*mm21","1*mm02","1*mm03","1*mm12","1*mm10","1*mm20","1*mm30","1*mm11","1*mm12","1*mm21","","","","","","","","","","","","")
,c("1*mm02","1*mm12","1*mm22","1*mm03","1*mm04","1*mm13","2*mm11","2*mm21","2*mm31","2*mm12","2*mm13","2*mm22","","","","","","","1*mm10","1*mm20","1*mm30","1*mm11","1*mm12","1*mm21")
,c("2*mm11","2*mm21","2*mm31","2*mm12","2*mm13","2*mm22","1*mm20","1*mm30","1*mm40","1*mm21","1*mm22","1*mm31","1*mm01","1*mm11","1*mm21","1*mm02","1*mm03","1*mm12","","","","","","")
,c("2*mm12","2*mm22","2*mm32","2*mm13","2*mm14","2*mm23","2*mm21","2*mm31","2*mm41","2*mm22","2*mm23","2*mm32","1*mm02","1*mm12","1*mm22","1*mm03","1*mm04","1*mm13","1*mm20","1*mm30","1*mm40","1*mm21","1*mm22","1*mm31")
,c("1*mm03","1*mm13","1*mm23","1*mm04","1*mm05","1*mm14","3*mm12","3*mm22","3*mm32","3*mm13","3*mm14","3*mm23","","","","","","","3*mm11","3*mm21","3*mm31","3*mm12","3*mm13","3*mm22")
,c("3*mm21","3*mm31","3*mm41","3*mm22","3*mm23","3*mm32","1*mm30","1*mm40","1*mm50","1*mm31","1*mm32","1*mm41","3*mm11","3*mm21","3*mm31","3*mm12","3*mm13","3*mm22","","","","","",""))

MAT=rbind(
 c("1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","")
,c("2*m10","2*m20","2*m30","2*m11","2*m12","2*m21","","","","","","","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","","","","","","","","","","","","","","","","","","")
,c("3*m20","3*m30","3*m40","3*m21","3*m22","3*m31","","","","","","","3*m10","3*m20","3*m30","3*m11","3*m12","3*m21","","","","","","","","","","","","","","","","","","")
,c("4*m30","4*m40","4*m50","4*m31","4*m32","4*m41","","","","","","","6*m20","6*m30","6*m40","6*m21","6*m22","6*m31","","","","","","","","","","","","","","","","","","")
,c("","","","","","","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","","","","","","","","","","","","","","","","","","","","","","","","")
,c("","","","","","","2*m01","2*m11","2*m21","2*m02","2*m03","2*m12","","","","","","","","","","","","","","","","","","","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11")
,c("","","","","","","3*m02","3*m12","3*m22","3*m03","3*m04","3*m13","","","","","","","","","","","","","","","","","","","3*m01","3*m11","3*m21","3*m02","3*m03","3*m12")
,c("","","","","","","4*m03","4*m13","4*m23","4*m04","4*m05","4*m14","","","","","","","","","","","","","","","","","","","6*m02","6*m12","6*m22","6*m03","6*m04","6*m13")
,c("1*m01","1*m11","1*m21","1*m02","1*m03","1*m12","1*m10","1*m20","1*m30","1*m11","1*m12","1*m21","","","","","","","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","1*m00","1*m10","1*m20","1*m01","1*m02","1*m11","","","","","","")
,c("1*m02","1*m12","1*m22","1*m03","1*m04","1*m13","2*m11","2*m21","2*m31","2*m12","2*m13","2*m22","","","","","","","2*m01","2*m11","2*m21","2*m02","2*m03","2*m12","2*m01","2*m11","2*m21","2*m02","2*m03","2*m12","1*m10","1*m20","1*m30","1*m11","1*m12","1*m21")
,c("2*m11","2*m21","2*m31","2*m12","2*m13","2*m22","1*m20","1*m30","1*m40","1*m21","1*m22","1*m31","1*m01","1*m11","1*m21","1*m02","1*m03","1*m12","2*m10","2*m20","2*m30","2*m11","2*m12","2*m21","2*m10","2*m20","2*m30","2*m11","2*m12","2*m21","","","","","","")
,c("2*m12","2*m22","2*m32","2*m13","2*m14","2*m23","2*m21","2*m31","2*m41","2*m22","2*m23","2*m32","1*m02","1*m12","1*m22","1*m03","1*m04","1*m13","4*m11","4*m21","4*m31","4*m12","4*m13","4*m22","4*m11","4*m21","4*m31","4*m12","4*m13","4*m22","1*m20","1*m30","1*m40","1*m21","1*m22","1*m31")
,c("1*m03","1*m13","1*m23","1*m04","1*m05","1*m14","3*m12","3*m22","3*m32","3*m13","3*m14","3*m23","","","","","","","3*m02","3*m12","3*m22","3*m03","3*m04","3*m13","3*m02","3*m12","3*m22","3*m03","3*m04","3*m13","3*m11","3*m21","3*m31","3*m12","3*m13","3*m22")
,c("3*m21","3*m31","3*m41","3*m22","3*m23","3*m32","1*m30","1*m40","1*m50","1*m31","1*m32","1*m41","3*m11","3*m21","3*m31","3*m12","3*m13","3*m22","3*m20","3*m30","3*m40","3*m21","3*m22","3*m31","3*m20","3*m30","3*m40","3*m21","3*m22","3*m31","","","","","","")
)

MAT2=rbind(
 c("1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","")
,c("2*mm10","2*mm20","2*mm30","2*mm11","2*mm12","2*mm21","","","","","","","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","","","","","","","","","","","","","","","","","","")
,c("3*mm20","3*mm30","3*mm40","3*mm21","3*mm22","3*mm31","","","","","","","3*mm10","3*mm20","3*mm30","3*mm11","3*mm12","3*mm21","","","","","","","","","","","","","","","","","","")
,c("4*mm30","4*mm40","4*mm50","4*mm31","4*mm32","4*mm41","","","","","","","6*mm20","6*mm30","6*mm40","6*mm21","6*mm22","6*mm31","","","","","","","","","","","","","","","","","","")
,c("","","","","","","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","","","","","","","","","","","","","","","","","","","","","","","","")
,c("","","","","","","2*mm01","2*mm11","2*mm21","2*mm02","2*mm03","2*mm12","","","","","","","","","","","","","","","","","","","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11")
,c("","","","","","","3*mm02","3*mm12","3*mm22","3*mm03","3*mm04","3*mm13","","","","","","","","","","","","","","","","","","","3*mm01","3*mm11","3*mm21","3*mm02","3*mm03","3*mm12")
,c("","","","","","","4*mm03","4*mm13","4*mm23","4*mm04","4*mm05","4*mm14","","","","","","","","","","","","","","","","","","","6*mm02","6*mm12","6*mm22","6*mm03","6*mm04","6*mm13")
,c("1*mm01","1*mm11","1*mm21","1*mm02","1*mm03","1*mm12","1*mm10","1*mm20","1*mm30","1*mm11","1*mm12","1*mm21","","","","","","","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","1*mm00","1*mm10","1*mm20","1*mm01","1*mm02","1*mm11","","","","","","")
,c("1*mm02","1*mm12","1*mm22","1*mm03","1*mm04","1*mm13","2*mm11","2*mm21","2*mm31","2*mm12","2*mm13","2*mm22","","","","","","","2*mm01","2*mm11","2*mm21","2*mm02","2*mm03","2*mm12","2*mm01","2*mm11","2*mm21","2*mm02","2*mm03","2*mm12","1*mm10","1*mm20","1*mm30","1*mm11","1*mm12","1*mm21")
,c("2*mm11","2*mm21","2*mm31","2*mm12","2*mm13","2*mm22","1*mm20","1*mm30","1*mm40","1*mm21","1*mm22","1*mm31","1*mm01","1*mm11","1*mm21","1*mm02","1*mm03","1*mm12","2*mm10","2*mm20","2*mm30","2*mm11","2*mm12","2*mm21","2*mm10","2*mm20","2*mm30","2*mm11","2*mm12","2*mm21","","","","","","")
,c("2*mm12","2*mm22","2*mm32","2*mm13","2*mm14","2*mm23","2*mm21","2*mm31","2*mm41","2*mm22","2*mm23","2*mm32","1*mm02","1*mm12","1*mm22","1*mm03","1*mm04","1*mm13","4*mm11","4*mm21","4*mm31","4*mm12","4*mm13","4*mm22","4*mm11","4*mm21","4*mm31","4*mm12","4*mm13","4*mm22","1*mm20","1*mm30","1*mm40","1*mm21","1*mm22","1*mm31")
,c("1*mm03","1*mm13","1*mm23","1*mm04","1*mm05","1*mm14","3*mm12","3*mm22","3*mm32","3*mm13","3*mm14","3*mm23","","","","","","","3*mm02","3*mm12","3*mm22","3*mm03","3*mm04","3*mm13","3*mm02","3*mm12","3*mm22","3*mm03","3*mm04","3*mm13","3*mm11","3*mm21","3*mm31","3*mm12","3*mm13","3*mm22")
,c("3*mm21","3*mm31","3*mm41","3*mm22","3*mm23","3*mm32","1*mm30","1*mm40","1*mm50","1*mm31","1*mm32","1*mm41","3*mm11","3*mm21","3*mm31","3*mm12","3*mm13","3*mm22","3*mm20","3*mm30","3*mm40","3*mm21","3*mm22","3*mm31","3*mm20","3*mm30","3*mm40","3*mm21","3*mm22","3*mm31","","","","","","")
)

 namess = c('a00','a10','a20','a01','a02','a11',
            'b00','b10','b20','b01','b02','b11',
            'c00','c10','c20','c01','c02','c11',
            'd00','d10','d20','d01','d02','d11',
            'e00','e10','e20','e01','e02','e11',
            'f00','f10','f20','f01','f02','f11')

 objlist=objects(pos=1)
 checknames = rep(0,length(namess))
 for(i in 1:length(namess))
 {
    if(sum(objlist==namess[i])==1){checknames[i] = 1}
 }
 whichnames = which(checknames==1)
 ##print(namess[whichnames])
 dims= rep('',14*2)
 for(i in 1:14)
 {
   for(j in whichnames)
   {
     if(MAT[i,j]!='')
     {
      dims[i] =paste0(dims[i],'+(',body(namess[j])[2],')*(',MAT[i,j],')')
      dims[i+14] =paste0(dims[i+14],'+(',body(namess[j])[2],')*(',MAT2[i,j],')')

     }
   }
 }
 ##print(MAT)
 write.table(data.frame(dims),'OODEs.txt')

 namess2 = c('Lam1','Lam2','Nmu11','Nsig11','Nmu21','Nsig21','Nmu12','Nsig12','Nmu22','Nsig22','Nu1x','Nu2x','Nu1y','Nu2y')
 checknames2 = rep(0,length(namess2))
 for(i in 1:length(namess2))
 {
    if(sum(objlist==namess2[i])==1){checknames2[i] = 1}
 }
 whichnames2 = which(checknames2==1)


 if(checknames2[1]==0){Lam1=function(t){0}}
 if(checknames2[2]==0){Lam2=function(t){0}}
 if(checknames2[3]==0){Nmu11=function(t){0}}
 if(checknames2[4]==0){Nsig11=function(t){0};Nmu11=function(t){0}}
 if(checknames2[5]==0){Nmu21=function(t){0}}
 if(checknames2[6]==0){Nsig21=function(t){0};Nmu21=function(t){0}}
 if(checknames2[7]==0){Nmu12=function(t){0}}
 if(checknames2[8]==0){Nsig12=function(t){0};Nmu12=function(t){0}}
 if(checknames2[9]==0){Nmu22=function(t){0}}
 if(checknames2[10]==0){Nsig22=function(t){0};Nmu22=function(t){0}}
 if(checknames2[11]==0){Nu1x=function(t){0}}
 if(checknames2[12]==0){Nu2x=function(t){0}}
 if(checknames2[13]==0){Nu1y=function(t){0}}
 if(checknames2[14]==0){Nu2y=function(t){0}}

 if(checknames2[1]==1)
 {
  for(i in 1:14)
  {
     dims[i] = paste0(dims[i],'+(',body(namess2[1])[2],')*(',Mstar1[i],')')
  }
 }

 if(checknames2[2]==1)
 {
  for(i in 1:14)
  {
     dims[i] = paste0(dims[i],'+(',body(namess2[2])[2],')*(',Mstar2[i],')')
  }
 }

  if(checknames2[11]==1)
 {
  for(i in 1:14)
  {
     dims[i] = paste0(dims[i],'+(',body(namess2[11])[2],')*(',Mstar1x[i],')')
  }
 }

   if(checknames2[12]==1)
 {
  for(i in 1:14)
  {
     dims[i] = paste0(dims[i],'+(',body(namess2[12])[2],')*(',Mstar2x[i],')')
  }
 }
   if(checknames2[13]==1)
 {
  for(i in 1:14)
  {
     dims[i] = paste0(dims[i],'+(',body(namess2[13])[2],')*(',Mstar1y[i],')')
  }
 }

   if(checknames2[14]==1)
 {
  for(i in 1:14)
  {
     dims[i] = paste0(dims[i],'+(',body(namess2[14])[2],')*(',Mstar2y[i],')')
  }
 }

 prem =
 '
     mm1 = mu11
     mm2 = (mu11^2)+ (sig11^2)
     mm3 = (mu11^3)+ 3* (mu11^1)*(sig11^2)
     mm4 = (mu11^4)+ 6* (mu11^2)*(sig11^2)+3*(sig11^4)

     oo1 = mu21
     oo2 = (mu21^2)+ (sig21^2)
     oo3 = (mu21^3)+ 3* (mu21^1)*(sig21^2)
     oo4 = (mu21^4)+ 6* (mu21^2)*(sig21^2)+3*(sig21^4)

     nn1 = mu12
     nn2 = (mu12^2)+ (sig12^2)
     nn3 = (mu12^3)+ 3* (mu12^1)*(sig12^2)
     nn4 = (mu12^4)+ 6* (mu12^2)*(sig12^2)+3*(sig12^4)

     pp1 = mu22
     pp2 = (mu22^2)+ (sig22^2)
     pp3 = (mu22^3)+ 3* (mu22^1)*(sig22^2)
     pp4 = (mu22^4)+ 6* (mu22^2)*(sig22^2)+3*(sig22^4)
 '
     premprem =rep('',4)
     #'Lam1','Lam2','Nmu11','Nsig11','Nmu21','Nsig21','Nmu12','Nsig12','Nmu22','Nsig22','Nu1x','Nu2x','Nu1y','Nu2y'
     if(checknames2[3]==1){premprem[1]= paste0(' mu11=',body('Nmu11')[2],';',' sig11=',body('Nsig11')[2],';')}
     if(checknames2[5]==1){premprem[3]= paste0(' mu21=',body('Nmu21')[2],';',' sig21=',body('Nsig21')[2],';')}
     if(checknames2[7]==1){premprem[2]= paste0(' mu12=',body('Nmu12')[2],';',' sig12=',body('Nsig12')[2],';')}
     if(checknames2[9]==1){premprem[4]= paste0(' mu22=',body('Nmu22')[2],';',' sig22=',body('Nsig22')[2],';')}
     if(checknames2[3]==0){premprem[1]= paste0(' mu11=',0,';',' sig11=',0,';')}
     if(checknames2[5]==0){premprem[3]= paste0(' mu21=',0,';',' sig21=',0,';')}
     if(checknames2[7]==0){premprem[2]= paste0(' mu12=',0,';',' sig12=',0,';')}
     if(checknames2[9]==0){premprem[4]= paste0(' mu22=',0,';',' sig22=',0,';')}
    prm=''
   for(i in 1:4)
   {
     prm = paste0(prm,premprem[i],'\n ')
   }
   ##print(prm)
   if(checknames2[1]==1){b1 = paste0('(',body('Lam1')[2],')')}else{b1 = paste0('(',0,')')}
   if(checknames2[2]==1){b2 = paste0('(',body('Lam2')[2],')')}else{b2 = paste0('(',0,')')}
   if(checknames2[11]==1){b3 = paste0('(',body('Nu1x')[2],')')}else{b3 = paste0('(',0,')')}
   if(checknames2[12]==1){b4 = paste0('(',body('Nu2x')[2],')')}else{b4 = paste0('(',0,')')}
   if(checknames2[13]==1){b5 = paste0('(',body('Nu1y')[2],')')}else{b5 = paste0('(',0,')')}
   if(checknames2[14]==1){b6 = paste0('(',body('Nu2y')[2],')')}else{b6 = paste0('(',0,')')}

   odekernel=paste0('c(',dims[1],'\n,',dims[2],'\n,',dims[3],'\n,',dims[4],
                   '\n,',dims[5],'\n,',dims[6],'\n,',dims[7],'\n,',dims[8],'\n,',dims[9],'\n,',dims[10],
                   '\n,',dims[11],'\n,',dims[12],'\n,',dims[13],'\n,',dims[14],'\n,',dims[1+14],'\n,',dims[2+14],'\n,',dims[3+14],'\n,',dims[4+14],
                   '\n,',dims[5+14],'\n,',dims[6+14],'\n,',dims[7+14],'\n,',dims[8+14],'\n,',dims[9+14],'\n,',dims[10+14],
                   '\n,',dims[11+14],'\n,',dims[12+14],'\n,',dims[13+14],'\n,',dims[14+14],'\n,',b1,'\n,',b2,'\n,',b3,'\n,',b4,'\n,',b5,'\n,',b6,')')

    pr=
    '
    m00=1
    m10=x[1]
    m20=x[2]
    m30=x[3]
    m40=x[4]
    m01=x[5]
    m02=x[6]
    m03=x[7]
    m04=x[8]
    m11=x[9]
    m12=x[10]
    m21=x[11]
    m22=x[12]
    m13=x[13]
    m31=x[14]
    mm00=1
    mm10=x[1+14]
    mm20=x[2+14]
    mm30=x[3+14]
    mm40=x[4+14]
    mm01=x[5+14]
    mm02=x[6+14]
    mm03=x[7+14]
    mm04=x[8+14]
    mm11=x[9+14]
    mm12=x[10+14]
    mm21=x[11+14]
    mm22=x[12+14]
    mm13=x[13+14]
    mm31=x[14+14]
    '
   odekernel=paste0('{ \n',pr,prm,prem,odekernel,'}')
   write(odekernel,'res.txt')
   ff <- function(x,t){}
   body(ff) = (parse(text=odekernel))
     t.alpha=
     c(0.000000000000000000000000000000000000000000000000000000000000,
       0.100000000000000000000000000000000000000000000000000000000000,
       0.539357840802981787532485197881302436857273449701009015505500,
       0.809036761204472681298727796821953655285910174551513523258250,
       0.309036761204472681298727796821953655285910174551513523258250,
       0.981074190219795268254879548310562080489056746118724882027805,
       0.833333333333333333333333333333333333333333333333333333333333,
       0.354017365856802376329264185948796742115824053807373968324184,
       0.882527661964732346425501486979669075182867844268052119663791,
       0.642615758240322548157075497020439535959501736363212695909875,
       0.357384241759677451842924502979560464040498263636787304090125,
       0.117472338035267653574498513020330924817132155731947880336209,
       0.833333333333333333333333333333333333333333333333333333333333,
       0.309036761204472681298727796821953655285910174551513523258250,
       0.539357840802981787532485197881302436857273449701009015505500,
       0.100000000000000000000000000000000000000000000000000000000000,
       1.00000000000000000000000000000000000000000000000000000000000)

       type.sol ="                  GENERALIZED QUADRATIC DIFFUSON"
   trim <- function (x) gsub("([[:space:]])", "", x)
   namess4=c('a00','a10','a20','a01','a02','a11',
             'b00','b10','b20','b01','b02','b11',
             'c00','c10','c20','c01','c02','c11',
             'd00','d10','d20','d01','d02','d11',
             'e00','e10','e20','e01','e02','e11',
             'f00','f10','f20','f01','f02','f11')
   indnames =rep(0,36)
   for(i in 1:36)
   {
     if(sum(objlist==namess4[i]))
     {
       indnames[i]=TRUE
       namess4[i]=paste0(namess4[i],' : ',trim(body(namess4[i])[2]))
     }
   }
   namess4=matrix(namess4,length(namess4),1)
   buffer0=c('================================================================')
   buffer1=c('----------------------------------------------------------------')
   buffer2=c('................................................................')
   buffer3=c('...   ...   ...   ...   ...   ...   ...   ...   ...   ...   ... ')
   buffer4=c('_____________________ Drift Coefficients _______________________')
   buffer5=c('___________________ Diffusion Coefficients _____________________')

   #Info1=data.frame(rbind(buffer0,matrix(names4[1:6,],6,1),buffer3,matrix(names4[1:6+6,],6,1),buffer3,matrix(names4[1:6+12,],6,1),buffer3,matrix(names4[1:6+18,],6,1),buffer3,matrix(names4[1:6+24,],6,1),buffer3,matrix(names4[1:6+30,],6,1),buffer2,prior.list,buffer),check.names=F)
   #colnames(Info1)=type.sol
   #buffer00=data.frame(buffer0,check.names=F)
   #colnames(buffer00)=''
   #print(buffer00 ,row.names = FALSE,right=F)
   #print(Info1,row.names = FALSE,right=F)
   # print(indnames)
   Info=c(buffer0,type.sol,buffer0,buffer4,
          namess4[1:6][which(indnames[1:6]==T)],
          buffer3,
          namess4[7:12][which(indnames[7:12]==T)],
          buffer5,
          namess4[13:18][which(indnames[13:18]==T)],
          buffer3,
          namess4[19:24][which(indnames[19:24]==T)],
          buffer3,
          namess4[25:30][which(indnames[25:30]==T)],
          buffer3,
          namess4[31:36][which(indnames[31:36]==T)])
   Info=data.frame(matrix(Info,length(Info),1))
   colnames(Info)=''
   print(Info,row.names = FALSE,right=F)

       N=round((t-s)/delt)
       ttt=seq(s,t,by=delt)
       seq1=c(1,2,3,4,0,0,0,0,1,1,2,2,1,3)
       seq2=c(0,0,0,0,1,2,3,4,1,2,1,2,3,1)
       x00= rep(0,14*2+6)
       for(i in 1:length(seq1))
       {
          x00[i] = (Xs^seq1[i])*(Ys^seq2[i])
          x00[i+14] = (Xs^seq1[i])*(Ys^seq2[i])
       }
       pb <- txtProgressBar(1,2*N,1,style = 1,width = 65)
       #print(x00)
       solver=function(x00)
       {
         MM=matrix(0,2*14+6,N+1)
         MA= x00
         tt=s

         MM[,1]=MA
         ii=1
         while(ii < N+1)
        {
           ii=ii+1
           x0=MA
           fx0=ff(x0,tt)
           x1=x0+delt*(0.1*fx0)
           fx1=ff(x1,tt+t.alpha[2]*delt)
           x2=x0+delt*(-0.915176561375291*fx0  +1.45453440217827*fx1)
           fx2=ff(x2,tt+t.alpha[3]*delt)
           x3=x0+delt*( 0.202259190301118*fx0  +0.606777570903354*fx2)
           fx3=ff(x3,tt+t.alpha[4]*delt)
           x4=x0+delt*( 0.184024714708644*fx0  +0.197966831227192*fx2-0.0729547847313633*fx3)
           fx4=ff(x4,tt+t.alpha[5]*delt)
           x5=x0+delt*( 0.0879007340206681*fx0 +0.410459702520261*fx3+0.482713753678866*fx4)
           fx5=ff(x5,tt+t.alpha[6]*delt)
           x6=x0+delt*(0.085970050490246*fx0   +0.330885963040722*fx3+0.48966295730945*fx4-0.0731856375070851*fx5)
           fx6=ff(x6,tt+t.alpha[7]*delt)
           x7=x0+delt*(0.120930449125334*fx0   +0.260124675758296*fx4+0.0325402621549091*fx5-0.0595780211817361*fx6)
           fx7=ff(x7,tt+t.alpha[8]*delt)
           x8=x0+delt*(0.110854379580391*fx0   -0.0605761488255006*fx5+0.321763705601778*fx6+0.510485725608063*fx7)
           fx8=ff(x8,tt+t.alpha[9]*delt)
           x9=x0+delt*(0.112054414752879*fx0   -0.144942775902866*fx5-0.333269719096257*fx6+0.49926922955688*fx7+0.509504608929686*fx8)
           fx9=ff(x9,tt+t.alpha[10]*delt)
           x10=x0+delt*(0.113976783964186*fx0  -0.0768813364203357*fx5+0.239527360324391*fx6+0.397774662368095*fx7+0.0107558956873607*fx8-0.327769124164019*fx9)
           fx10=ff(x10,tt+t.alpha[11]*delt)
           x11=x0+delt*(0.0798314528280196*fx0 -0.0520329686800603*fx5-0.0576954146168549*fx6+0.194781915712104*fx7+0.145384923188325*fx8-0.0782942710351671*fx9-0.114503299361099*fx10)
           fx11=ff(x11,tt+t.alpha[12]*delt)
           x12=x0+delt*(0.985115610164857*fx0  +0.330885963040722*fx3+0.48966295730945*fx4-1.37896486574844*fx5-0.861164195027636*fx6+5.78428813637537*fx7+3.28807761985104*fx8-2.38633905093136*fx9-3.25479342483644*fx10-2.16343541686423*fx11)
           fx12=ff(x12,tt+t.alpha[13]*delt)
           x13=x0+delt*(0.895080295771633*fx0  +0.197966831227192*fx2-0.0729547847313633*fx3-0.851236239662008*fx5+0.398320112318533*fx6+3.63937263181036*fx7+1.5482287703983*fx8-2.12221714704054*fx9-1.58350398545326*fx10-1.71561608285936*fx11-0.0244036405750127*fx12)
           fx13=ff(x13,tt+t.alpha[14]*delt)
           x14=x0+delt*(-0.915176561375291*fx0+1.45453440217827*fx1+0*fx2+0*fx3-0.777333643644968*fx4+0*fx5-0.0910895662155176*fx6+0.0910895662155176*fx12+0.777333643644968*fx13)
           fx14=ff(x14,tt+t.alpha[15]*delt)
           x15=x0+delt*(0.1*fx0-0.157178665799771*fx2+0.157178665799771*fx14)
           fx15=ff(x15,tt+t.alpha[16]*delt)
           x16=x0+delt*(0.181781300700095*fx0+0.675*fx1+0.34275815984719*fx2+0*fx3+0.259111214548323*fx4-0.358278966717952*fx5-1.04594895940883*fx6+0.930327845415627*fx7+1.77950959431708*fx8+0.1*fx9-0.282547569539044*fx10-0.159327350119973*fx11-0.145515894647002*fx12-0.259111214548323*fx13-0.34275815984719*fx14-0.675*fx15)
           fx16=ff(x16,tt+t.alpha[17]*delt)

           MA=MA+(0.0333333333333333333333333333333333333333333333333333333333333*fx0
                +0.0250000000000000000000000000000000000000000000000000000000000*fx1
                +0.0333333333333333333333333333333333333333333333333333333333333*fx2
                +0.000000000000000000000000000000000000000000000000000000000000*fx3
                +0.0500000000000000000000000000000000000000000000000000000000000*fx4
                +0.000000000000000000000000000000000000000000000000000000000000*fx5
                +0.0400000000000000000000000000000000000000000000000000000000000*fx6
                +0.000000000000000000000000000000000000000000000000000000000000*fx7
                +0.189237478148923490158306404106012326238162346948625830327194*fx8
                +0.277429188517743176508360262560654340428504319718040836339472*fx9
                +0.277429188517743176508360262560654340428504319718040836339472*fx10
                +0.189237478148923490158306404106012326238162346948625830327194*fx11
                -0.0400000000000000000000000000000000000000000000000000000000000*fx12
                -0.0500000000000000000000000000000000000000000000000000000000000*fx13
                -0.0333333333333333333333333333333333333333333333333333333333333*fx14
                -0.0250000000000000000000000000000000000000000000000000000000000*fx15
                +0.0333333333333333333333333333333333333333333333333333333333333*fx16)*delt

                tt=tt+delt
                MM[,ii]=MA
                setTxtProgressBar(pb,ii," "," ")
           }
           return(MM)
    }

     MM=solver(x00)
     #print(length(ff(x00,tt)))
     #print(ff(x00,tt))
     #return(0)
    # windows()
    # plot(MM[1,],type='n',ylim=range(log(MM)))
    # for(i in 1:14)
    # {
    #     lines(log(MM[i,]),col=2)
    #     lines(log(MM[i+14,]),col=4)
    # }
    nnn = length(Xt)

    if(Dtype=='Saddlepoint')
    {
     n1=dim(MM)[1]
     n2=dim(MM)[2]

    kkk=0
    DDD=array(0,dim=c(nnn,nnn,n2))
    nr.updates=rep(0,n2-1)
    a=rep(0,nnn*nnn)
    b=rep(0,nnn*nnn)
   for(lll in 2:n2)
   {
      setTxtProgressBar(pb,lll+N," "," ")
      kkk=kkk+1
      x=MM[,lll]

  m00=1
  m10=x[1]
  m20=x[2]
  m30=x[3]
  m40=x[4]
  m01=x[5]
  m02=x[6]
  m03=x[7]
  m04=x[8]
  m11=x[9]
  m12=x[10]
  m21=x[11]
  m22=x[12]
  m13=x[13]
  m31=x[14]

  k10 = m10
  k20 = m20-m10^2
  k30 = m30-3*m20*m10+2*m10^3
  k40 = m40 -4*m30*m10-3*m20^2+12*m20*m10^2-6*m10^4
  k01 = m01
  k02 = m02-  m01^2
  k03 = m03-3*m02*m01+2*m01^3
  k04 = m04-4*m03*m01-3*m02^2+12*m02*m01^2-6*m01^4
  k11 = m11-m10*m01
  k21 = m21-2*m11*m10-m20*m01+2*m10^2*m01
  k12 = m12-2*m11*m01-m02*m10+2*m01^2*m10
  k22 = m22-2*m21*m01-2*m12*m10-m20*m02-2*m11^2+8*m11*m01*m10+2*m02*m10^2+2*m20*m01^2-6*m10^2*m01^2
  k31 = m31-3*m21*m10-m30*m01-3*m20*m11+6*m11*m10^2+6*m20*m10*m01-6*m10^3*m01
  k13 = m13-3*m12*m01-m03*m10-3*m02*m11+6*m11*m01^2+6*m02*m01*m10-6*m01^3*m10
    tme=proc.time()
    ffab=function(xm1,xm2,a=rep(5,nnn*nnn),b=rep(2,nnn*nnn))
    {
     XMAT1=xm1
     XMAT2=xm2


     k=0
     abser=rep(0.1,nnn*nnn)
       while((k<5000)&(sum(abser>0.001)>0))
       {
         # K= k10*a+k01*b+1/2*k20*a^2+1/2*k02*b^2+1/6*k30*a^3+1/6*k03*b^3+1/24*k40*a^4+1/24*k04*b^4+k11*a*b+1/2*k12*a*b^2+1/2*k21*a^2*b+1/6*a*b^3*k13+1/6*a^3*b*k31+1/4*a^2*b^2*k22
          gg=k10+k20*a+1/2*k30*a^2+1/6*k40*a^3 +k11*b +1/2*k12*b^2+k21*a*b+1/6*b^3*k13+1/2*a^2*b*k31+1/2*a*b^2*k22-XMAT1
          hh=k01+k02*b+1/2*k03*b^2+1/6*k04*b^3 +k11*a +k12*a*b+1/2*k21*a^2+1/2*a*b^2*k13+1/6*a^3*k31+1/2*a^2*b*k22-XMAT2
          gg1=k20+k30*a+1/2*k40*a^2+k21*b+a*b*k31+1/2*b^2*k22
          gg2=k11 +k12*b+k21*a+1/2*b^2*k13+1/2*a^2*k31+a*b*k22
          hh1=k11 +k12*b+k21*a+1/2*b^2*k13+1/2*a^2*k31+a*b*k22
          hh2=k02+k03*b+1/2*k04*b^2 +k12*a+a*b*k13+1/2*a^2*k22
          DK2=gg1*hh2-gg2*hh1
          ar=(hh*gg2-gg*hh2)/(gg1*hh2-gg2*hh1)
          br=(hh*gg1-gg*hh1)/(gg1*hh2-gg2*hh1)
          anew  =a+ar
          bnew  =b-br
          abser =((anew-a)^2+(bnew-b)^2)
          itrue =(abser>0.001)
          ifalse=(abser<=0.001)
          #print(itrue)
          a=anew#*ifalse+anew*itrue
          b=bnew#*ifalse+bnew*itrue
          k=k+1
       }

       return(list(a=a,b=b,k=k))
    }

    fff=function(a,b,xmat1,xmat2)
    {
       K= k10*a+k01*b+1/2*k20*a^2+1/2*k02*b^2+1/6*k30*a^3+1/6*k03*b^3+1/24*k40*a^4+1/24*k04*b^4+k11*a*b+1/2*k12*a*b^2+1/2*k21*a^2*b+1/6*a*b^3*k13+1/6*a^3*b*k31+1/4*a^2*b^2*k22
       gg=k10+k20*a+1/2*k30*a^2+1/6*k40*a^3 +k11*b +1/2*k12*b^2+k21*a*b+1/6*b^3*k13+1/2*a^2*b*k31+1/2*a*b^2*k22-xmat1
       hh=k01+k02*b+1/2*k03*b^2+1/6*k04*b^3 +k11*a +k12*a*b+1/2*k21*a^2+1/2*a*b^2*k13+1/6*a^3*k31+1/2*a^2*b*k22-xmat2
       gg1=k20+k30*a+1/2*k40*a^2+k21*b+a*b*k31+1/2*b^2*k22
       gg2=k11 +k12*b+k21*a+1/2*b^2*k13+1/2*a^2*k31+a*b*k22
       hh1=k11 +k12*b+k21*a+1/2*b^2*k13+1/2*a^2*k31+a*b*k22
       hh2=k02+k03*b+1/2*k04*b^2 +k12*a+a*b*k13+1/2*a^2*k22
       DK2=gg1*hh2-gg2*hh1
       return(exp(K-a*xmat1-b*xmat2)/(2*pi)/sqrt(DK2))
    }


      cc=ffab(X1,X2,a,b)
    a=cc[[1]]
    b=cc[[2]]
    nr.updates[lll-1]=cc$k
    DDD[,,lll]=t(matrix(fff(cc$a,cc$b,X1,X2),nnn,nnn,byrow=T))
    tme=proc.time()-tme
    #print(tme)
   }
   }

     EE =MM[1:14,]*0
     for(i in 1:14)
     {
        EE[i,] = (MM[i,]-MM[i+14,]*exp(-MM[29,]-MM[30,]-MM[31,]-MM[32,]-MM[33,]-MM[34,]))/(1-exp(-MM[29,]-MM[30,]-MM[31,]-MM[32,]-MM[33,]-MM[34,]))
     }


   if(Dtype=='Edgeworth')
   {

        ffff=function(xx,yy,m)
       {
        X=rep(xx,length(yy))
        Y=rep(yy,each=length(xx))

         H=function(x,i)
         {
            switch(i+1,
            {1},
            {x},
            {x^2-1},
            {x^3-3*x},
            {x^4-6*x^2+3},
            {x^5-10*x^3+15*x},
            {x^6-15*x^4+45*x^2-15})
         }

          m00=1
          m10=m[1]
          m20=m[2]
          m30=m[3]
          m40=m[4]
          m01=m[5]
          m02=m[6]
          m03=m[7]
          m04=m[8]
          m11=m[9]
         m12=m[10]
         m21=m[11]
         m22=m[12]
         m13=m[13]
         m31=m[14]

         k10 = m10
         k20 = m20-m10^2
         k30 = m30-3*m20*m10+2*m10^3
         k40 = m40 -4*m30*m10-3*m20^2+12*m20*m10^2-6*m10^4
         k01 = m01
         k02 = m02-  m01^2
         k03 = m03-3*m02*m01+2*m01^3
         k04 = m04-4*m03*m01-3*m02^2+12*m02*m01^2-6*m01^4
         k11 = m11-m10*m01
         k21 = m21-2*m11*m10-m20*m01+2*m10^2*m01
         k12 = m12-2*m11*m01-m02*m10+2*m01^2*m10
         k22 = m22-2*m21*m01-2*m12*m10-m20*m02-2*m11^2+8*m11*m01*m10+2*m02*m10^2+2*m20*m01^2-6*m10^2*m01^2
         k31 = m31-3*m21*m10-m30*m01-3*m20*m11+6*m11*m10^2+6*m20*m10*m01-6*m10^3*m01
         k13 = m13-3*m12*m01-m03*m10-3*m02*m11+6*m11*m01^2+6*m02*m01*m10-6*m01^3*m10

          x = (X-k10)/sqrt(k20)
          y = (Y-k01)/sqrt(k02)
          rho20 =1
          rho30 =k30/(sqrt(k20)^3)
          rho40 =k40/(sqrt(k20)^4)

          rho02 =1
          rho03 =k03/(sqrt(k02)^3)
          rho04 =k04/(sqrt(k02)^4)

          rho11 =k11/(sqrt(k20)*sqrt(k02))
          rho12 =k12/(sqrt(k20)*sqrt(k02)^2)
          rho21 =k21/(sqrt(k20)^2*sqrt(k02))
          rho22 =k22/(sqrt(k20)^2*sqrt(k02)^2)
          rho13 =k13/(sqrt(k20)^1*sqrt(k02)^3)
          rho31 =k31/(sqrt(k20)^3*sqrt(k02)^1)


          rho = k11/sqrt(k02*k20)
          dmvnorm <- function(x,y)
          {
          	 1/(2*pi*sqrt(k20*k02)*sqrt(1 - rho^2))*exp(-((x-k10)^2/k20 -2*rho*(x-k10)*(y-k01)/sqrt(k20 * k02)+(y-k01)^2/k02)/(2*(1-rho^2)))
          }

        A=H(x,3)*rho30+3*H(x,2)*H(y,1)*rho21+3*H(x,1)*H(y,2)*rho12+H(y,3)*rho03
        B=H(x,4)*rho40+4*H(x,3)*H(y,1)*rho31+6*H(x,2)*H(y,2)*rho22+4*H(x,1)*H(y,3)*rho13+H(y,4)*rho04
        CC=H(x,6)*rho30^2+6*H(x,5)*H(y,1)*rho21*rho30+6*H(x,4)*H(y,2)*rho12*rho30+2*H(x,3)*H(y,3)*rho03*rho30+9*H(x,4)*H(y,2)*rho21^2+18*H(x,3)*H(y,3)*rho12*rho21+6*H(x,2)*H(y,4)*rho03*rho21+9*H(x,2)*H(y,4)*rho12^2+6*H(x,1)*H(y,5)*rho03*rho12+H(y,6)*rho03^2
        val=pmax(dmvnorm(X,Y)*(1+1/6*A+1/24*B+1/72*CC),0)


       return(val)
       }

       DDD=array(0,dim=c(nnn,nnn,dim(MM)[2]))
       DDD[1,1,1] = 1
       for(i in 2:dim(MM)[2])
       {
         DDD[,,i]=exp(-MM[29,i]-MM[30,i]-MM[31,i]-MM[32,i]-MM[33,i]-MM[34,i])*ffff(Xt,Yt,MM[15:28,i])+(1-exp(-MM[29,i]-MM[30,i]-MM[31,i]-MM[32,i]-MM[33,i]-MM[34,i]))*ffff(Xt,Yt,EE[,i])
         setTxtProgressBar(pb,i+N," "," ")
       }
   }
   close(pb)
    DD1=matrix(0,nnn,dim(MM)[2])
           saddlep=function(xx,m)
       {
        k =m*0
        k[1,]=                                          m[1,]
        k[2,]=                               m[2,]-1*k[1,]*m[1,]
        k[3,]=                m[3,]-1*k[1,]*m[2,]-2*k[2,]*m[1,]
        k[4,]= m[4,]-1*k[1,]*m[3,]-3*k[2,]*m[2,]-3*k[3,]*m[1,]

        p=1/3*(3*(k[4,]/6)*k[2,] - ((k[3,]/2)^2))/((k[4,]/6)^2)
        q=1/27*(27*((k[4,]/6)^2)*(k[1,]-xx) - 9*(k[4,]/6)*(k[3,]/2)*k[2,] + 2*((k[3,]/2)^3))/((k[4,]/6)^3)
        chk=(q^2)/4 + (p^3)/27
        th=-(k[3,]/2)/(3*(k[4,]/6))+(-q/2+sqrt(chk))^(1/3)-(q/2+sqrt(chk))^(1/3)

        K=k[1,]*th+(k[2,]*th^2)/2+(k[3,]*th^3)/6 +(k[4,]*th^4)/24
        K1=k[1,]+(k[2,]*th)+(k[3,]*th^2)/2+(k[4,]*th^3)/6
        K2=k[2,]+(k[3,]*th)+(k[4,]*th^2)/2
        K3=k[3,]+(k[4,]*th)
        K4=k[4,]
        return(1/sqrt(2*pi*(K2))*exp(K-th*K1))
       }
      for(i in 1:length(Xt))
    {

      DD1[i,]=saddlep(Xt[i],MM[1:4,])
    }
    DD2=matrix(0,nnn,dim(MM)[2])
      for(i in 1:length(Yt))
    {
     DD2[i,]=saddlep(Yt[i],MM[1:4+4,])
    }
   rownames(MM) =c("m10","m20","m30","m40","m01","m02","m03","m04","m11","m12","m21","m22","m13","m31","mm10","mm20","mm30","mm40","mm01","mm02","mm03","mm04","mm11","mm12","mm21","mm22","mm13","mm31",'ILam1','ILam2','INu1x','INu2x','INu1y','INu2y')

   retlist=list(density=DDD,time=seq(s,t,delt),Xt=Xt,Yt=Yt,moments=MM,Xmarginal=DD1,Ymarginal=DD2,excess_moments=EE,zero_jump_prob=exp(-MM[29,i]-MM[30,i]-MM[31,i]-MM[32,i]-MM[33,i]-MM[34,i]))
   class(retlist) = "BiJGQD.density"
   return(retlist)
 }







